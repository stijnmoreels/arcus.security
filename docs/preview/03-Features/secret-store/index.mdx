---
title: "Secret store"
slug: /features/secret-store
sidebar_position: 1
---

import Card from '@site/src/Components/Card';
import CardHeader from '@site/src/Components/Card/CardHeader';
import CardBody from '@site/src/Components/Card/CardBody';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Introducing secret store
As an alternative to the usage of placing secrets into Microsoft's [`IConfiguration`](https://learn.microsoft.com/en-us/dotnet/core/extensions/configuration) instance in your application, Arcus Security provides a alternative concept called '**secret store**'.

We provide an approach similar to how `IConfiguration` is built, but with a focus on secrets. You can register one or more '**secret providers**' where you want your application secrets to be retrieved from. 

<div className="row">
<div className="col col--6">
  <Card shadow='tl'>
      <CardHeader>
        <h3>‚ö° Caching</h3>
      </CardHeader>
      <CardBody>
       We provide caching so the secret providers will not be called upon every secret retrieval. This helps you avoiding hitting service limitations.
      </CardBody>
  </Card>
</div>

<div className="col col--6">
  <Card shadow='tl'>
      <CardHeader>
        <h3>üîå Plug & play</h3>
      </CardHeader>
      <CardBody>
        We support using multiple and combinations of secret providers so with a single secret retrieval can query multiple secret providers (also multiple Azure Key Vaults).
      </CardBody>
  </Card>
</div>
</div>
<br/>
<div className="row">
  <div className="col col--6">
    <Card shadow='tl'>
      <CardHeader>
        <h3>üõ°Ô∏è Security by design</h3>
      </CardHeader>
      <CardBody>
        Vulnerabilities gets introduced when secrets are seen as data (logs or when expired secrets doesn't get transient handling upon retrieval).
        The secret store provides a single place to retrieve secrets instead of scattering the integration across the application. 
    </CardBody>
  </Card>
  </div>
  <div className="col col--6">
    <Card shadow='tl'>
      <CardHeader>
        <h3>üß© Extensibility</h3>
      </CardHeader>
      <CardBody>
        Arcus secret store is highly extensible and can be extended with [your own custom secret providers](./custom-secret-provider.md).
    </CardBody>
  </Card>
  </div>
</div>

## Register the secret store
The secret store is configured during the initial application build-up with one ore more secret providers:

```csharp
using Arcus.Security;

var builder = Host.CreateDefaultBuilder(args);

// highlight-start
// #1 Via the host builder.
builder.ConfigureSecretStore((config, store) =>
{
    store.AddEnvironmentVariables(...);
});
// highlight-end

builder.ConfigureServices(services =>
{
    // highlight-start
    // #2 Via the services
    services.AddSecretStore(store =>
    {
        store.AddAzureKeyVault(...);
    });
    // highlight-end
});
```

The secret store is directly available via the `ISecretStore` interface which provides multiple secret retrieval options. Upon retrieval, the previously registered secret providers are one-by-one (in the order as they are registered) interacted with until the secret is found, or the `SecretResult` represents a failure.

```csharp
using Arcus.Security;

public class MySqlService
{
    private readonly ISecretStore _store;

    public MySqlService(ISecretStore store)
    {
        _store = store;
    }

    public async Task ConnectAsync()
    {
        // #1 synchronously
        // highlight-start
        SecretResult result = _store.GetSecret("Contoso_Sql_ConnectionString");
        string secretValue = result.Value;
        // highlight-end

        // #2 asynchronously
        // highlight-start
        SecretResult result = await _store.GetSecretAsync("Contoso_Sql_ConnectionString");
        if (!result.IsSuccess)
        {
            SecretFailure failure = result.Failure; // The type of failure that occurred.
            Exception cause = result.FailureCause; // When the failure was caused by an exception.
        }
        // highlight-end
    }
}
```

## Customization the secret store
<details>
<summary><h3 style={{ margin:0 }}>‚ö° Secret caching</h3></summary>

To limit possible throttling during external secrets retrieval, the secret store can be customized to cache secrets for a period of time.

```csharp
builder.ConfigureServices(services =>
{
    services.AddSecretStore(store =>
    {
        store.UseCaching(TimeSpan.FromMinutes(1));
    })
});
```

All secrets are cached by default, but this can be ignored on a by-secret basis.
```csharp
using Arcus.Security;

ISecretStore store = ...
SecretResult result = store.GetSecret("Contoso_Sql_ConnectionString", options => 
{
    options.UseCache = false;
});
```

Invalidating cached secrets when secrets are externally rotated also happens on the secret store itself.
```csharp
using Arcus.Security;

ISecretStore store = ...
await store.Cache.InvalidateSecretAsync("Contoso_Sql_ConnectionString");
```
</details>

<details>
<summary><h3 style={{ margin:0 }}>üîÑ Secret mapping</h3></summary>

In some cases, you want the application secret name to be something different than the actual name that gets stored externally. Environment variables, for example might be always upper case, but this knowledge might not be something that you want to expose directly to your application -- especially if you want to override certain secrets during development.

All available secret secret providers can be given a custom secret name mapping upon registration. This mapping happens just before actually retrieving the secret (and independently from secret caching).

```csharp
builder.ConfigureServices(services =>
{
    services.AddSecretStore(store =>
    {
        store.AddEnvironmentVariables(..., options =>
        {
            options.MapSecretName((string name) => name.ToUpper());
        });
    })
});
```
</details>

<details>
<summary><h3 style={{ margin:0 }}>üè∑Ô∏è Naming secret providers</h3></summary>

All available secret providers can be given a custom name upon registration to identify themselves.

```csharp
builder.ConfigureServices(services =>
{
    services.AddAzureKeyVault(..., options =>
    {
        options.ProviderName = "AdminSecrets";
    });
});
```

This name can later be used to retrieve back a secret provider in the secret store. This can be useful when you want to run a specific action that is only available on a single secret provider (ex. secret versions).

```csharp
using Arcus.Security;

ISecretStore store = ...
var provider = store.GetProvider<KeyVaultSecretProvider>("AdminSecrets");
```

:::tip[grouping secret providers]
Multiple secret providers can be registered with the same name. Upon retrieval, the matching secret providers are returned as a 'subset'.
```csharp
using Arcus.Security;

ISecretProvider provider = store.GetProvider("AdminSecrets");
```
:::
</details>

## Built-in secret providers
The following secret providers are always available in your application, no matter which secret provider NuGet package you install.

<Tabs groupId="built-in">
<TabItem value="app-config" label="App configuration">
Include the application configuration ([`IConfiguration`](https://learn.microsoft.com/en-us/dotnet/core/extensions/configuration)) as a secret provider in the secret store. This is useful for development, but **SHOULD NOT** be used in production.

```csharp
builder.ConfigureSecretStore((IConfiguration config, store) =>
{
    #if DEBUG
    store.AddConfiguration(config);
    #endif
});
```

</TabItem>
<TabItem value="env-vars" label="Environment variables">
Include environment variables as a secret provider in the secret store. Some additional options (besides the default ones) are available to pinpoint which variables should be included as application secrets.

```csharp
builder.ConfigureSecretStore((_, store) =>
{
     // Uses the environment variables associated with the current process.
    store.AddEnvironmentVariables();

    store.AddEnvironmentVariables(options =>
    {
        // Uses only the environment variables starting with a prefix.
        // Upon secret retrieval, the prefix should not be included in the secret name.
        // (default: none)
        options.Prefix = "ARCUS_";

        // Uses only the environment variables from a given target.
        // (default: Process)
        options.Target = EnvironmentVariableTarget.Machine;
    });
});
```
</TabItem>
</Tabs>